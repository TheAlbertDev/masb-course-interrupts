name: ğŸ§ª STM32Cube interrupts - PR check

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize
      - reopened
      - edited

permissions:
  contents: read

jobs:
  acceptance_tests:
    name: âœ… Build and Run Acceptance tests
    if: |
      !github.event.repository.is_template &&
      github.head_ref == 'stm32cube-interrupts'
    runs-on: self-hosted
    steps:
      - name: ğŸ›¡ï¸ Get GitHub App token
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ secrets.THEALBERTDEVBOT_APP_ID }}
          private-key: ${{ secrets.THEALBERTDEVBOT_SECRET_KEY }}
          owner: ${{ github.repository_owner }}

      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v6
        with:
          token: ${{ steps.app-token.outputs.token }}

      - name: ğŸ—ï¸ Build and upload STM32Cube project
        run: |
          cd ${{ github.workspace }}/stm32cube/workspace/interrupts
          rm -rf build/Debug
          cmake -G Ninja -DCMAKE_BUILD_TYPE=Debug -DCMAKE_TOOLCHAIN_FILE=./cmake/gcc-arm-none-eabi.cmake -B build/Debug
          cmake --build build/Debug
          pio pkg exec -p tool-openocd -c "openocd -f interface/stlink.cfg -f target/stm32f4x.cfg -c 'program build/Debug/interrupts.elf verify reset exit'"

      - name: ğŸ§¬ Run unit tests
        env:
          CPPUTEST_HOME: /opt/cpputest
        run: |
          cd ${{ github.workspace }}/.github/tests/unit/test_interrupts/stm32cube
          make

      - name: ğŸ§¬ Run acceptance tests
        run: |
          cd ${{ github.workspace }}/.github/tests/acceptance/test_interrupts
          /usr/bin/python3 -m venv .venv
          source .venv/bin/activate
          pip install -r requirements.txt
          python -m pytest -v
